<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TechMuscleGod Workout Timer</title>

  <!-- Chart.js for progress graphs (cached offline by service worker) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f1724;
      --card:#111827;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --glass:rgba(255,255,255,0.03)
    }

    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:#e6eef6;
      background:linear-gradient(180deg,#071022 0%,#04101a 100%);
      margin:0;
      padding:10px;
      min-height:100vh;
      box-sizing:border-box;
    }

    .wrap{max-width:980px;margin:0 auto}
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px
    }
    h1{
      font-size:20px;
      margin:0;
      color:var(--accent);
    }

    /* LAYOUT */
    .topRow{
      display:flex;
      flex-direction:row;
      align-items:stretch;
      gap:18px;
      margin-bottom:18px;
      flex-wrap:nowrap;
    }

    .colCard{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
    }

    @media (max-width:768px){
      body{padding:8px;}
      h1{font-size:18px;}
      .timer{font-size:32px !important;}
      .card h3{font-size:15px;}
      .controls button{
        font-size:13px;
        padding:8px 6px;
      }
    }

    .card{
      background:var(--card);
      padding:10px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);

      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    /* Workout header */
    .exerciseHeaderBlock{
      border-bottom:1px solid rgba(255,255,255,0.1);
      padding-bottom:8px;
      margin:0 0 12px;
    }
    .exerciseHeaderTopRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }
    .exerciseHeaderTitleGroup{
      flex:1;
      min-width:0;
    }
    #currentWorkoutTitleStatic{
      font-size:14px;
      font-weight:600;
      color:#e6eef6;
      line-height:1.3;
    }
    .editBtn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.2);
      color:var(--accent);
      font-size:12px;
      padding:6px 8px;
      border-radius:8px;
      font-weight:500;
    }
    .editBtn:active{
      transform:scale(.98);
    }

    .dayPickerGroup label{
      font-size:10px;
      color:var(--muted);
      letter-spacing:.05em;
      text-transform:uppercase;
      display:block;
      margin-bottom:4px;
    }
    .dayPickerBtn{
      width:100%;
      text-align:left;
      background:#071022;
      color:#fff;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:8px;
      padding:12px;
      font-size:16px;
      line-height:1.3;
      min-height:44px;
      cursor:pointer;
    }
    .dayPickerBtn:active{
      transform:scale(.98);
    }

    /* Exercise item styling */
    .exercise{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px;
      border-radius:8px;
      background:var(--glass);
      margin-bottom:6px;
      transition:background .2s;
      cursor:pointer;
      font-size:12px;
    }
    .exercise:hover{background:rgba(255,255,255,0.08);}
    .exercise strong{display:block}
    .small{font-size:11px;color:var(--muted)}

    /* Scroll list */
    .exerciseListScroll{
      flex:1;
      min-height:0;
      max-height:calc(100vh - 280px);
      overflow-y:auto;
      padding-right:6px;
      scrollbar-color:var(--accent) var(--card);
      scrollbar-width:thin;
      min-height:200px;
    }

    /* Timer visuals */
    .timer{
      font-size:48px;
      font-weight:700;
      text-align:center;
      margin-top:10px;
      letter-spacing:2px;
      color:var(--accent);
    }
    .progress{
      height:8px;
      background:#0b1220;
      border-radius:6px;
      overflow:hidden;
      margin-top:10px;
    }
    .bar{
      height:100%;
      background:linear-gradient(90deg,#06b6d4,#60a5fa);
      width:0%;
      transition:width 1s linear;
    }

    /* Buttons / inputs */
    button{
      background:var(--accent);
      border:0;
      color:#052026;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      transition:background .2s,transform .1s;
      font-size:14px;
    }
    button:hover{background:#22d3ee;}
    button:active{transform:scale(0.98);}

    .smallbtn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:400;
      font-size:12px;
    }
    .smallbtn:hover{background:rgba(255,255,255,0.05);}

    .controls{
      display:flex;
      gap:6px;
      align-items:center;
      margin-top:10px;
    }

    label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:6px 0 3px
    }
    input[type="number"],input[type="text"],select.basicInput{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
      background:#071022;
      color:#fff;
      box-sizing:border-box;
      font-size:13px;
    }

    .tracking-inputs{
      display:flex;
      gap:6px;
    }
    .tracking-inputs>div{flex:1;}

    /* History card */
    .historyCard{
      width:100%;
      box-sizing:border-box;
    }
    .historyWrapHeader{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .historyTitle{
      font-size:14px;
      font-weight:600;
      color:#e6eef6;
      line-height:1.3;
    }
    .historySubtitle{
      font-size:10px;
      color:var(--muted);
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .historySelectGroup{
      min-width:140px;
      flex-shrink:0;
    }
    #historyExerciseSelect{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.2);
      background:#071022;
      color:#fff;
      font-size:13px;
    }
    #historyTable{
      max-height:160px;
      overflow-y:auto;
      font-size:11px;
      color:#cbd5e1;
      line-height:1.4;
      border-top:1px solid rgba(255,255,255,0.07);
      margin-top:10px;
      padding-top:6px;
    }
    .historyRow{
      display:grid;
      grid-template-columns:2fr 1fr 1fr;
      gap:6px;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .exNameCell{
      color:#e2e8f0;
      font-weight:500;
      word-break:break-word;
    }
    .exMeta{
      font-size:10px;
      color:#64748b;
    }
    .numCell{
      text-align:right;
      color:#e2e8f0;
      font-weight:500;
    }
    .numLabel{
      font-size:10px;
      text-align:right;
      color:#64748b;
    }

    footer{
      margin-top:14px;
      color:var(--muted);
      font-size:11px
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:#1e293b;
      color:#fff;
      font-size:12px;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 10px 30px rgba(0,0,0,0.7);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s;
      z-index:9999;
    }

    /* EDIT MODAL */
    #editOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
      z-index:10000;
    }
    #editSheet{
      background:var(--card);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 20px 40px rgba(0,0,0,0.8);
      width:100%;
      max-width:360px;
      max-height:60vh;
      display:flex;
      flex-direction:column;
    }
    #editHeader{
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:8px;
    }
    #editHeaderTitle{
      font-size:14px;
      font-weight:600;
      color:#e2e8f0;
      line-height:1.3;
    }
    #editHeaderSub{
      font-size:10px;
      color:var(--muted);
    }
    #editCloseBtn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.2);
      color:#fff;
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      font-weight:500;
    }
    #editBody{
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:12px 16px;
      font-size:12px;
      color:#fff;
    }
    .editExerciseRow{
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      padding:8px;
      margin-bottom:8px;
      background:#1e2537;
    }
    .editExerciseName{
      font-size:13px;
      font-weight:600;
      color:#e2e8f0;
    }
    .editExerciseMeta{
      font-size:11px;
      color:#94a3b8;
      margin-bottom:6px;
    }
    .editRowBtns{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .miniBtn{
      flex:1;
      min-width:60px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:8px;
      color:#fff;
      font-size:11px;
      padding:6px;
      text-align:center;
    }
    .miniBtn.danger{
      border-color:#ef4444;
      color:#ef4444;
    }
    .miniBtn.move{
      border-color:#06b6d4;
      color:#06b6d4;
    }
    #addExerciseBtn,
    #exportBtn,
    #importBtn{
      width:100%;
      margin-top:8px;
      background:var(--accent);
      color:#052026;
      border-radius:8px;
      border:0;
      font-size:12px;
      font-weight:600;
      padding:8px;
    }
    #exportBtn,
    #importBtn{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(255,255,255,0.2);
    }
    #editFooterNote{
      text-align:center;
      font-size:10px;
      color:#64748b;
      padding:8px 16px 16px;
    }
    #importFileInput{display:none;}

    /* WORKOUT DAY PICKER SHEET */
    #dayPickerOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
      z-index:11000;
    }
    #dayPickerSheet{
      background:var(--card);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 20px 40px rgba(0,0,0,0.8);
      width:100%;
      max-width:360px;
      max-height:60vh;
      display:flex;
      flex-direction:column;
    }
    #dayPickerHeader{
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:8px;
    }
    #dayPickerTitle{
      font-size:14px;
      font-weight:600;
      color:#e2e8f0;
      line-height:1.3;
    }
    #dayPickerCloseBtn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.2);
      color:#fff;
      border-radius:8px;
      padding:4px 8px;
      font-size:12px;
      font-weight:500;
    }
    #dayPickerList{
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:12px 16px;
      font-size:12px;
      color:#fff;
    }
    .dayOptionBtn{
      width:100%;
      text-align:left;
      border:1px solid rgba(255,255,255,0.15);
      background:#1e2537;
      border-radius:8px;
      padding:10px 12px;
      font-size:13px;
      color:#e2e8f0;
      line-height:1.4;
      margin-bottom:8px;
    }
    .dayOptionBtn.current{
      border-color:#06b6d4;
      box-shadow:0 0 10px rgba(6,182,212,0.4);
    }
    .dayOptionBtn:active{
      transform:scale(.98);
    }
    .dayOptionSub{
      font-size:11px;
      color:#94a3b8;
      margin-top:2px;
    }
  </style>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f1724">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TechMuscleGod">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>TechMuscleGod</h1>
      </div>
      <div class="small muted">3-Day Split</div>
    </header>

    <!-- TOP ROW: Workout (left) + Timer (right), equal height -->
    <div class="topRow">
      <!-- Workout / Exercises Card -->
      <div class="colCard">
        <div class="card" id="workoutCard">
          <div class="exerciseHeaderBlock">
            <div class="exerciseHeaderTopRow">
              <div class="exerciseHeaderTitleGroup">
                <div id="currentWorkoutTitleStatic">Workouts &amp; Exercises</div>
              </div>
              <button class="editBtn" id="editWorkoutBtn">Edit</button>
            </div>

            <div class="dayPickerGroup">
              <label for="dayPickerBtn">Workout Day</label>
              <button id="dayPickerBtn" class="dayPickerBtn">Loading...</button>
            </div>
          </div>

          <div class="exerciseListScroll" id="exerciseList"></div>
        </div>
      </div>

      <!-- Timer Card -->
      <div class="colCard">
        <div class="card" id="timerCard">
          <h3 style="margin:0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px;">Rest Timer</h3>
          
          <div class="timer" id="timerDisplay">00:00</div>
          <div class="small" id="currentLabel" style="text-align:center;color:var(--accent);">Idle</div>
          
          <div class="progress"><div class="bar" id="bar"></div></div>

          <label>Selected Exercise</label>
          <input type="text" id="selectedExercise" class="basicInput" readonly value="Please Select an Exercise">

          <label>Sets × Reps (Target)</label>
          <input type="text" id="setsReps" class="basicInput" readonly>

          <div class="tracking-inputs">
            <div>
              <label>Last Weight (kg)</label>
              <input type="number" id="lastWeightInput" class="basicInput" min="0" step="2.5" placeholder="Enter Weight">
            </div>
            <div>
              <label>Last Reps</label>
              <input type="number" id="lastRepsInput" class="basicInput" min="1" step="1" placeholder="Enter Reps">
            </div>
          </div>

          <label>Rest (seconds)</label>
          <input type="number" id="restInput" class="basicInput" min="10" step="5" value="60">

          <label>Sets Remaining</label>
          <input type="number" id="setsRemaining" class="basicInput" min="1" value="3">

          <div class="controls">
            <button id="startBtn" style="flex:1;">Start</button>
            <button class="smallbtn" id="pauseBtn">Pause</button>
            <button class="smallbtn" id="resetBtn">Reset</button>
          </div>

          <div style="margin-top:16px; border-top:1px solid var(--glass); padding-top:10px;">
            <label>Auto-advance sets</label>
            <select id="autoAdvance" class="basicInput">
              <option value="1">On</option>
              <option value="0">Off</option>
            </select>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="saveMetricsBtn" class="smallbtn" style="flex:1;min-width:90px;">Save Set</button>
            <button id="soundTest" class="smallbtn" style="flex:1;min-width:90px;">Test Sound</button>
            <button id="downloadBtn" class="smallbtn" style="flex:1;min-width:90px;">Download HTML</button>
          </div>

          <footer>Tip: Everything is saved locally on your device only.</footer>
        </div>
      </div>
    </div>

    <!-- BOTTOM ROW: Progress / History full width -->
    <div class="historyCard card" id="historyCard">
      <div class="historyWrapHeader">
        <div>
          <div class="historySubtitle">Progress</div>
          <div class="historyTitle">Strength Over Time</div>
        </div>
        <div class="historySelectGroup">
          <label for="historyExerciseSelect" style="font-size:11px;color:var(--muted);margin-bottom:3px;">Exercise</label>
          <select id="historyExerciseSelect"></select>
        </div>
      </div>

      <canvas id="progressChart" width="400" height="200"></canvas>

      <div id="historyTable"></div>
    </div>
  </div>

  <!-- EDIT SHEET OVERLAY -->
  <div id="editOverlay">
    <div id="editSheet">
      <div id="editHeader">
        <div style="flex:1;min-width:0;">
          <div id="editHeaderTitle">Edit</div>
          <div id="editHeaderSub">Workout setup</div>
        </div>
        <button id="editCloseBtn">Close</button>
      </div>

      <div id="editBody"></div>

      <div style="padding:0 16px 16px;">
        <button id="addExerciseBtn">+ Add Exercise</button>
        <button id="exportBtn">Export Backup</button>
        <button id="importBtn">Import Backup</button>
        <input id="importFileInput" type="file" accept="application/json">
      </div>

      <div id="editFooterNote">Plan + history are stored locally. Export to save them somewhere safe.</div>
    </div>
  </div>

  <!-- WORKOUT DAY PICKER OVERLAY -->
  <div id="dayPickerOverlay">
    <div id="dayPickerSheet">
      <div id="dayPickerHeader">
        <div id="dayPickerTitle">Select Workout Day</div>
        <button id="dayPickerCloseBtn">Close</button>
      </div>
      <div id="dayPickerList"></div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const METRIC_KEY_PREFIX = 'TechMuscleGod_Metrics_';
    const SET_LOG_KEY = 'TechMuscleGod_SetLog_v1';
    const PLAN_KEY = 'TechMuscleGod_WorkoutPlan_v1';

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.opacity = '1';
      setTimeout(()=>{t.style.opacity='0';},2000);
    }

    function formatTime(s){
      const mm = Math.floor(s/60).toString().padStart(2,'0');
      const ss = (s%60).toString().padStart(2,'0');
      return mm+':'+ss;
    }

    function ymd(dateStr){
      const d = new Date(dateStr);
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    }
    function hm(dateStr){
      const d = new Date(dateStr);
      return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    }

    const defaultPlan = [
      {day:'Workout 1 – Lower Push / Upper Push & Pull', items:[
        {name:'Barbell Back Squat', sets:'4×6–10', rest:150},
        {name:'Leg Extensions (Machine)', sets:'3×12–15', rest:50},
        {name:'Flat Barbell Bench Press', sets:'4×6–10', rest:150},
        {name:'One-Arm Dumbbell Row', sets:'3×8–12', rest:100},
        {name:'Dumbbell Lateral Raise', sets:'3×10–15', rest:50},
        {name:'Bodyweight or Weighted Dips', sets:'3×8–12', rest:150},
        {name:'Hammer Curls', sets:'2×10–12', rest:70},
        {name:'Plank', sets:'2×30–60 sec', rest:40}
      ]},
      {day:'Workout 2 – Lower Pull / Upper Push & Pull', items:[
        {name:'Conventional Deadlift', sets:'3×6–8', rest:150},
        {name:'Romanian Deadlift', sets:'3×8–12', rest:100},
        {name:'Leg Curl (Machine)', sets:'3×12–15', rest:50},
        {name:'Standing Barbell Overhead Press', sets:'3×6–10', rest:150},
        {name:'Pull-Ups or Lat Pulldowns', sets:'3×8–12', rest:100},
        {name:'Reverse Pec Deck or Rear Delt Fly', sets:'3×12–15', rest:50},
        {name:'Cable Rope Overhead Triceps Extension', sets:'3×10–12', rest:75},
        {name:'Hanging Leg Raises', sets:'2×10–15', rest:45}
      ]},
      {day:'Workout 3 – Unilateral & Accessory Focus', items:[
        {name:'Walking Dumbbell Lunges', sets:'3×10–12 per leg', rest:100},
        {name:'Incline Dumbbell Bench Press', sets:'3×8–12', rest:100},
        {name:'Face Pulls (Cable)', sets:'3×12–15', rest:50},
        {name:'Dumbbell Front Raise', sets:'2×10–15', rest:50},
        {name:'Concentration Curls', sets:'2×10–12 per arm', rest:75},
        {name:'Overhead Dumbbell Triceps Extension', sets:'2×10–12', rest:75},
        {name:'Russian Twists (Weighted)', sets:'2×15–20 per side', rest:40}
      ]}
    ];

    let plan = [];
    let selected = null;
    let timerInterval = null;
    let remaining = 0;
    let total = 0;
    let setsLeft = 0;
    let isRunning = false;
    let audioCtx = null;
    let chartObj = null;
    let setLog = [];
    let currentDayIndex = 0;

    const exList = document.getElementById('exerciseList');
    const timerDisplay = document.getElementById('timerDisplay');
    const currentLabel = document.getElementById('currentLabel');
    const selectedExerciseInput = document.getElementById('selectedExercise');
    const setsRepsInput = document.getElementById('setsReps');
    const restInput = document.getElementById('restInput');
    const setsRemainingInput = document.getElementById('setsRemaining');
    const lastWeightInput = document.getElementById('lastWeightInput');
    const lastRepsInput = document.getElementById('lastRepsInput');
    const bar = document.getElementById('bar');
    const autoAdvanceSelect = document.getElementById('autoAdvance');
    const saveMetricsBtn = document.getElementById('saveMetricsBtn');
    const soundTestBtn = document.getElementById('soundTest');
    const downloadBtn = document.getElementById('downloadBtn');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const historyExerciseSelect = document.getElementById('historyExerciseSelect');
    const historyTable = document.getElementById('historyTable');
    const progressChartCanvas = document.getElementById('progressChart');
    const editWorkoutBtn = document.getElementById('editWorkoutBtn');
    const editOverlay = document.getElementById('editOverlay');
    const editSheet = document.getElementById('editSheet');
    const editCloseBtn = document.getElementById('editCloseBtn');
    const editBody = document.getElementById('editBody');
    const addExerciseBtn = document.getElementById('addExerciseBtn');
    const editHeaderTitle = document.getElementById('editHeaderTitle');
    const editHeaderSub = document.getElementById('editHeaderSub');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileInput = document.getElementById('importFileInput');

    const dayPickerBtn = document.getElementById('dayPickerBtn');
    const dayPickerOverlay = document.getElementById('dayPickerOverlay');
    const dayPickerSheet = document.getElementById('dayPickerSheet');
    const dayPickerCloseBtn = document.getElementById('dayPickerCloseBtn');
    const dayPickerList = document.getElementById('dayPickerList');

    function loadPlan(){
      try{
        const raw = localStorage.getItem(PLAN_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            plan = parsed;
            return;
          }
        }
      }catch(e){
        console.warn("Plan load failed, using default", e);
      }
      plan = JSON.parse(JSON.stringify(defaultPlan));
    }
    function savePlan(){
      try {
        localStorage.setItem(PLAN_KEY, JSON.stringify(plan));
      } catch(e){
        console.error("savePlan failed", e);
      }
    }

    function loadSetLog(){
      try{
        const raw = localStorage.getItem(SET_LOG_KEY);
        if(raw){
          setLog = JSON.parse(raw) || [];
        }
      }catch(e){
        console.error('Failed to load set log', e);
        setLog = [];
      }
    }
    function saveSetLog(){
      try{
        localStorage.setItem(SET_LOG_KEY, JSON.stringify(setLog));
      }catch(e){
        console.error('Failed to save set log', e);
      }
    }

    function loadMetrics(exName){
      try{
        const data = localStorage.getItem(METRIC_KEY_PREFIX + exName);
        if(data){
          const m = JSON.parse(data);
          lastWeightInput.value = m.weight || '';
          lastRepsInput.value = m.reps || '';
          return true;
        }
      }catch(e){
        console.error('metrics load fail', e);
      }
      lastWeightInput.value = '';
      lastRepsInput.value = '';
      return false;
    }

    function saveMetrics(){
      if(!selected) return;
      const metrics = {
        weight: lastWeightInput.value,
        reps: lastRepsInput.value,
        timestamp: new Date().toISOString()
      };
      try{
        localStorage.setItem(METRIC_KEY_PREFIX + selected.name, JSON.stringify(metrics));
      }catch(e){
        console.error('Error saving metrics', e);
      }

      if(metrics.reps || metrics.weight){
        setLog.push({
          date: new Date().toISOString(),
          exerciseName: selected.name,
          weight: metrics.weight || null,
          reps: metrics.reps ? parseInt(metrics.reps,10) : null
        });
        saveSetLog();
      }

      currentLabel.textContent = 'Saved: ' + selected.name;
      showToast('Set saved');

      buildList(currentDayIndex);
      safeRenderHistory();
    }

    function playBeep(freq=440,duration=300){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type='sine';
        osc.frequency.value = freq;
        gain.gain.value = 0.12;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        setTimeout(()=>{osc.stop();}, duration);
      }catch(e){
        console.error('Audio API error:', e);
      }
    }

    function vibrate(ms=200){
      if(navigator.vibrate){
        navigator.vibrate(ms);
      }
    }

    function updateTimerDisplay(sec){
      total = sec;
      remaining = sec;
      timerDisplay.textContent = formatTime(remaining);
      bar.style.width = '0%';
    }

    function tick(){
      if(remaining<=0){
        playBeep(440,300);
        vibrate(200);
        clearInterval(timerInterval);
        timerInterval=null;
        isRunning=false;
        startBtn.textContent='Start';
        currentLabel.textContent='TIME UP!';

        if(autoAdvanceSelect.value==='1' && selected){
          setsLeft = Math.max(0, setsLeft-1);
          setsRemainingInput.value = setsLeft;
          
          if(setsLeft>0){
            currentLabel.textContent = 'Set done. Starting rest for set ' + setsLeft + '...';
            const sec = parseInt(restInput.value)||60;
            remaining = sec;
            total = sec;
            updateTimerDisplay(sec);
            setTimeout(()=>{startTimer();},1500);
          }else{
            currentLabel.textContent = '✅ ' + selected.name + ' complete!';
          }
        }
        return;
      }

      remaining--;
      timerDisplay.textContent = formatTime(remaining);
      const pct = ((total-remaining)/total)*100;
      bar.style.width = pct+'%';
    }

    function startTimer(){
      if(isRunning) return;

      if(!selected){
        currentLabel.textContent='Error: select exercise first';
        return;
      }

      const sec = parseInt(restInput.value)||60;
      if(remaining<=0){
        remaining = sec;
        total = sec;
      }
      if(total===0){
        total = sec;
      }

      playBeep(880,150);

      timerInterval = setInterval(tick,1000);
      isRunning=true;
      startBtn.textContent='Running...';
      currentLabel.textContent='Resting...';

      saveMetrics();
    }

    function pauseTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
        isRunning=false;
        startBtn.textContent='Resume';
        currentLabel.textContent='Paused';
      }
    }

    function resetTimer(){
      pauseTimer();
      const sec = parseInt(restInput.value)||60;
      remaining = sec;
      total = sec;
      timerDisplay.textContent = formatTime(remaining);
      bar.style.width = '0%';
      currentLabel.textContent='Reset. Select exercise to begin.';
    }

    function selectExercise(item){
      selected = item;
      selectedExerciseInput.value = item.name;
      setsRepsInput.value = item.sets;
      restInput.value = item.rest;

      loadMetrics(item.name);

      const match = item.sets.match(/(\d+)×/);
      const defaultSets = match ? parseInt(match[1],10) : 3;
      setsRemainingInput.value = defaultSets;
      setsLeft = defaultSets;

      currentLabel.textContent = 'Ready: ' + item.name;

      updateTimerDisplay(item.rest);
      pauseTimer();
      startBtn.textContent='Start';
    }

    function buildList(dayIndex){
      exList.innerHTML='';
      const day = plan[dayIndex];

      day.items.forEach(item=>{
        let hasMetrics=false;
        let previewWeight='';
        let previewReps='';

        try{
          const data = localStorage.getItem(METRIC_KEY_PREFIX + item.name);
          if(data){
            const m = JSON.parse(data);
            if(m){
              hasMetrics = true;
              previewWeight = m.weight || 'BW';
              previewReps = m.reps || '?';
            }
          }
        }catch(e){}

        const div = document.createElement('div');
        div.className='exercise';

        let indicator = hasMetrics ? '<span style="color:#60a5fa;">✓</span>' : '';
        let detailLine = item.sets+' / Rest: '+item.rest+'s '+indicator;
        if(hasMetrics && previewReps){
          detailLine += ' / Last: '+previewWeight+'kg × '+previewReps;
        }

        const left = document.createElement('div');
        left.innerHTML = '<strong>'+item.name+'</strong><div class="small">'+detailLine+'</div>';

        const right = document.createElement('div');
        const btn = document.createElement('button');
        btn.textContent='Select';
        btn.style.padding='4px 6px';

        div.onclick = ()=>selectExercise(item);

        right.appendChild(btn);
        div.appendChild(left);
        div.appendChild(right);
        exList.appendChild(div);
      });

      lastWeightInput.value='';
      lastRepsInput.value='';
    }

    function updateDayPickerButtonText(){
      if(plan[currentDayIndex]){
        dayPickerBtn.textContent = plan[currentDayIndex].day;
      }else{
        dayPickerBtn.textContent = 'Select Workout Day';
      }
    }

    function openDayPicker(){
      rebuildDayPickerList();
      dayPickerOverlay.style.display = 'flex';
    }
    function closeDayPicker(){
      dayPickerOverlay.style.display = 'none';
    }

    function rebuildDayPickerList(){
      dayPickerList.innerHTML='';
      plan.forEach((section, index)=>{
        const btn = document.createElement('button');
        btn.className='dayOptionBtn'+(index===currentDayIndex?' current':'');
        btn.innerHTML = section.day + '<div class="dayOptionSub">'+
          (section.items && section.items[0] ? section.items[0].name : '')+
          '</div>';
        btn.addEventListener('click',()=>{
          currentDayIndex = index;
          buildList(currentDayIndex);
          updateDayPickerButtonText();
          resetTimer();
          closeDayPicker();
        });
        dayPickerList.appendChild(btn);
      });
    }

    function initWorkoutPicker(){
      currentDayIndex = 0;
      buildList(currentDayIndex);
      updateDayPickerButtonText();
    }

    function openEditOverlay(){
      refreshEditOverlay();
      editOverlay.style.display = 'flex';
    }
    function closeEditOverlay(){
      editOverlay.style.display = 'none';
    }

    function moveExerciseUp(idx){
      if(idx<=0) return;
      const arr = plan[currentDayIndex].items;
      const temp = arr[idx-1];
      arr[idx-1] = arr[idx];
      arr[idx] = temp;
      savePlan();
      buildList(currentDayIndex);
      safeRenderHistory();
      refreshEditOverlay();
    }

    function moveExerciseDown(idx){
      const arr = plan[currentDayIndex].items;
      if(idx >= arr.length-1) return;
      const temp = arr[idx+1];
      arr[idx+1] = arr[idx];
      arr[idx] = temp;
      savePlan();
      buildList(currentDayIndex);
      safeRenderHistory();
      refreshEditOverlay();
    }

    function editExercise(idx){
      const exObj = plan[currentDayIndex].items[idx];
      const newName = prompt('Exercise name:', exObj.name);
      if(newName===null) return;
      const newSets = prompt('Sets × Reps (Target):', exObj.sets);
      if(newSets===null) return;
      const newRestRaw = prompt('Rest seconds (Timer):', exObj.rest);
      if(newRestRaw===null) return;
      const newRest = parseInt(newRestRaw,10) || exObj.rest;

      plan[currentDayIndex].items[idx] = {
        name:newName.trim() || exObj.name,
        sets:newSets.trim() || exObj.sets,
        rest:newRest
      };

      savePlan();
      buildList(currentDayIndex);
      safeRenderHistory();
      refreshEditOverlay();
      showToast('Exercise updated');
    }

    function deleteExercise(idx){
      if(!confirm('Delete this exercise?')) return;
      plan[currentDayIndex].items.splice(idx,1);
      savePlan();
      buildList(currentDayIndex);
      safeRenderHistory();
      refreshEditOverlay();
      showToast('Exercise deleted');
    }

    function addExercise(){
      const name = prompt('New exercise name:');
      if(!name){return;}
      const sets = prompt('Sets × Reps (Target):','3×8–12');
      if(sets===null){return;}
      const restRaw = prompt('Rest seconds (Timer):','90');
      if(restRaw===null){return;}
      const rest = parseInt(restRaw,10) || 60;

      plan[currentDayIndex].items.push({
        name:name.trim(),
        sets:sets.trim(),
        rest:rest
      });

      savePlan();
      buildList(currentDayIndex);
      safeRenderHistory();
      refreshEditOverlay();
      showToast('Exercise added');
    }

    function exportBackup(){
      const payload = {
        plan,
        setLog
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'TechMuscleGod_Backup.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(url);
        a.remove();
      },1000);
      showToast('Backup exported');
    }

    function importBackupFromFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = JSON.parse(e.target.result);
          if(data.plan && Array.isArray(data.plan)){
            plan = data.plan;
            savePlan();
          }
          if(data.setLog && Array.isArray(data.setLog)){
            setLog = data.setLog;
            saveSetLog();
          }
          initWorkoutPicker();
          safeRenderHistory();
          refreshEditOverlay();
          showToast('Backup imported');
        }catch(err){
          console.error('Import failed', err);
          showToast('Import failed (bad file)');
        }
      };
      reader.readAsText(file);
    }

    function refreshEditOverlay(){
      editHeaderTitle.textContent = 'Edit';
      editHeaderSub.textContent = 'Workout setup';
      editBody.innerHTML = '';

      plan[currentDayIndex].items.forEach((exObj, idx)=>{
        const row = document.createElement('div');
        row.className = 'editExerciseRow';

        row.innerHTML = `
          <div class="editExerciseName">${exObj.name}</div>
          <div class="editExerciseMeta">Target: ${exObj.sets} · Rest: ${exObj.rest}s</div>
          <div class="editRowBtns">
            <button class="miniBtn move" data-action="up" data-idx="${idx}">▲</button>
            <button class="miniBtn move" data-action="down" data-idx="${idx}">▼</button>
            <button class="miniBtn" data-action="edit" data-idx="${idx}">Edit</button>
            <button class="miniBtn danger" data-action="delete" data-idx="${idx}">Delete</button>
          </div>
        `;

        editBody.appendChild(row);
      });

      editBody.querySelectorAll('.miniBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const action = btn.getAttribute('data-action');
          const idx = parseInt(btn.getAttribute('data-idx'),10);
          if(action==='edit'){ editExercise(idx); }
          if(action==='delete'){ deleteExercise(idx); }
          if(action==='up'){ moveExerciseUp(idx); }
          if(action==='down'){ moveExerciseDown(idx); }
        });
      });
    }

    function buildHistoryExerciseOptions(){
      const seen = {};
      historyExerciseSelect.innerHTML='';

      plan.forEach(day=>{
        day.items.forEach(it=>{
          if(!seen[it.name]){
            seen[it.name] = true;
            const opt = document.createElement('option');
            opt.value = it.name;
            opt.textContent = it.name;
            historyExerciseSelect.appendChild(opt);
          }
        });
      });

      setLog.forEach(entry=>{
        if(!seen[entry.exerciseName]){
          seen[entry.exerciseName] = true;
          const opt2 = document.createElement('option');
          opt2.value = entry.exerciseName;
          opt2.textContent = entry.exerciseName;
          historyExerciseSelect.appendChild(opt2);
        }
      });
    }

    function buildChartDataForExercise(exName){
      const map = {};
      setLog.forEach(s=>{
        if(s.exerciseName===exName){
          const day = ymd(s.date);
          const val = (s.weight && s.weight!=='' ? parseFloat(s.weight) : (s.reps||0));
          if(!(day in map)){ map[day] = val; }
          else if(val > map[day]){ map[day] = val; }
        }
      });

      const days = Object.keys(map).sort((a,b)=>(new Date(a)-new Date(b)));
      const vals = days.map(d=>map[d]);
      return {labels:days, data:vals};
    }

    function renderChart(){
      if(!historyExerciseSelect.value) return;
      const ctx = progressChartCanvas.getContext('2d');
      const built = buildChartDataForExercise(historyExerciseSelect.value);
      const labels = built.labels;
      const data = built.data;

      if(chartObj){ chartObj.destroy(); }

      if(typeof Chart === 'undefined'){
        console.warn('Chart.js not available yet, skipping chart render');
        return;
      }

      chartObj = new Chart(ctx, {
        type:'line',
        data:{
          labels:labels,
          datasets:[{
            label:'Best (kg or reps)',
            data:data,
            borderColor:'#06b6d4',
            backgroundColor:'rgba(6,182,212,0.15)',
            borderWidth:2,
            tension:0.25,
            pointRadius:3,
            pointBackgroundColor:'#06b6d4'
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{
              labels:{
                color:'#e2e8f0',
                font:{size:10}
              }
            }
          },
          scales:{
            x:{
              grid:{color:'rgba(148,163,184,0.1)'},
              ticks:{color:'rgba(226,232,240,0.8)',font:{size:10}}
            },
            y:{
              grid:{color:'rgba(148,163,184,0.1)'},
              ticks:{color:'rgba(226,232,240,0.8)',font:{size:10}}
            }
          }
        }
      });
    }

    function renderHistoryTable(){
      const sorted = [...setLog].sort((a,b)=>(new Date(b.date)-new Date(a.date)));
      const last10 = sorted.slice(0,10);

      if(!last10.length){
        historyTable.innerHTML = '<div class="small" style="color:#64748b;padding-top:4px;">No sets logged yet.</div>';
        return;
      }

      const rows = last10.map(s=>{
        const dt = ymd(s.date)+' '+hm(s.date);
        return `
          <div class="historyRow">
            <div>
              <div class="exNameCell">${s.exerciseName}</div>
              <div class="exMeta">${dt}</div>
            </div>
            <div>
              <div class="numCell">${s.weight ? s.weight : 'BW'}kg</div>
              <div class="numLabel">weight</div>
            </div>
            <div>
              <div class="numCell">${s.reps || '?'} reps</div>
              <div class="numLabel">reps</div>
            </div>
          </div>
        `;
      }).join('');

      historyTable.innerHTML = rows;
    }

    function renderHistory(){
      buildHistoryExerciseOptions();
      renderHistoryTable();
      renderChart();
    }

    function safeRenderHistory(){
      try{
        renderHistory();
      }catch(err){
        console.warn('renderHistory failed but app continues', err);
      }
    }

    function registerServiceWorker(){
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('sw.js').catch(err=>{
          console.warn('SW registration failed', err);
        });
      }
    }

    function initEvents(){
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      soundTestBtn.addEventListener('click', ()=>playBeep(880,200));
      saveMetricsBtn.addEventListener('click', saveMetrics);

      downloadBtn.addEventListener('click', ()=>{
        try{
          const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href=url;
          a.download='TechMuscleGod_Workout_Timer.html';
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{
            URL.revokeObjectURL(url);
            a.remove();
          },1000);
        }catch(e){
          console.error('Download failed:', e);
        }
      });

      restInput.addEventListener('change', resetTimer);
      restInput.addEventListener('keyup', resetTimer);

      historyExerciseSelect.addEventListener('change', renderChart);

      editWorkoutBtn.addEventListener('click', openEditOverlay);
      editCloseBtn.addEventListener('click', closeEditOverlay);

      editOverlay.addEventListener('click', (e)=>{
        if(e.target === editOverlay){ closeEditOverlay(); }
      });
      editSheet.addEventListener('click', (e)=>{
        e.stopPropagation();
      });

      addExerciseBtn.addEventListener('click', addExercise);

      exportBtn.addEventListener('click', exportBackup);

      importBtn.addEventListener('click', ()=>{
        importFileInput.click();
      });
      importFileInput.addEventListener('change', (e)=>{
        const file = e.target.files && e.target.files[0];
        if(file){
          importBackupFromFile(file);
        }
        importFileInput.value = '';
      });

      dayPickerBtn.addEventListener('click', openDayPicker);
      dayPickerCloseBtn.addEventListener('click', closeDayPicker);

      dayPickerOverlay.addEventListener('click', (e)=>{
        if(e.target === dayPickerOverlay){
          closeDayPicker();
        }
      });
      dayPickerSheet.addEventListener('click',(e)=>{
        e.stopPropagation();
      });
    }

    function init(){
      loadPlan();
      loadSetLog();

      initWorkoutPicker();

      remaining = parseInt(restInput.value,10) || 60;
      total = remaining;
      timerDisplay.textContent = formatTime(remaining);
      currentLabel.textContent = 'Ready to start your workout!';

      initEvents();
      safeRenderHistory();
      registerServiceWorker();
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
